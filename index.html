<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dashboard Hormigón – Formato Oficial</title>
<style>
  :root {
    --bg:#f5f7fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --accent:#dc2626; --ok:#16a34a;
    --border:#e5e7eb; --shadow:0 8px 24px rgba(15,23,42,.08);
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial; background:var(--bg); color:var(--ink);}
  header{background:linear-gradient(90deg,#0b1220,#0f1f3a); color:#fff; padding:18px 20px;}
  header h1{margin:0;font-size:18px; font-weight:800;}
  header .sub{opacity:.9; margin-top:4px; font-size:13px;}
  .container{max-width:1400px; margin:18px auto; padding:0 14px;}
  .row{display:flex; gap:12px; flex-wrap:wrap;}
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow);}
  .toolbar{padding:14px; display:flex; gap:10px; align-items:end; flex-wrap:wrap;}
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
  input,select,textarea{width:100%; box-sizing:border-box; padding:9px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; outline:none;}
  textarea{min-height:38px; resize:vertical;}
  .field{min-width:180px; flex:1;}
  .btn{border:0; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700;}
  .btn.primary{background:var(--accent); color:#fff;}
  .btn.ok{background:var(--ok); color:#fff;}
  .btn.gray{background:#334155; color:#fff;}
  .kpis{padding:14px; display:grid; gap:10px; grid-template-columns:repeat(6, minmax(170px, 1fr));}
  .kpi{padding:12px; border-left:6px solid var(--accent); border-radius:12px; background:#fff; border:1px solid var(--border);}
  .kpi .v{font-size:22px; font-weight:900;}
  .kpi .t{font-size:12px; color:var(--muted);}
  @media (max-width:1100px){ .kpis{grid-template-columns:repeat(3, minmax(170px, 1fr));} }
  @media (max-width:720px){ .kpis{grid-template-columns:repeat(2, minmax(170px, 1fr));} }
  table{width:100%; border-collapse:collapse;}
  th,td{border-bottom:1px solid var(--border); padding:10px 10px; font-size:12px; vertical-align:top;}
  th{text-align:left; font-size:12px; color:#0b1220; background:#f8fafc; position:sticky; top:0; z-index:1;}
  .table-wrap{max-height:52vh; overflow:auto; border-top:1px solid var(--border); border-radius:0 0 14px 14px;}
  .titlebar{padding:12px 14px; display:flex; justify-content:space-between; align-items:center; gap:10px; border-bottom:1px solid var(--border);}
  .titlebar h2{margin:0; font-size:14px;}
  .pill{font-size:12px; color:var(--muted);}
  /* modal */
  .backdrop{position:fixed; inset:0; background:rgba(2,6,23,.55); display:none; align-items:center; justify-content:center; padding:16px;}
  .modal{width:min(1200px, 100%); max-height:92vh; overflow:auto;}
  .modal .body{padding:14px;}
  .grid{display:grid; grid-template-columns:repeat(6, minmax(160px,1fr)); gap:10px;}
  @media (max-width:1100px){ .grid{grid-template-columns:repeat(3, minmax(160px,1fr));} }
  @media (max-width:720px){ .grid{grid-template-columns:repeat(2, minmax(160px,1fr));} }
  .right{margin-left:auto;}
  .hint{font-size:12px; color:var(--muted); margin-top:6px;}
</style>
</head>
<body>
<header>
  <h1>Dashboard Hormigón – Sala de Control</h1>
  <div class="sub">Formato oficial (HORMIGONES): FECHA, MES, SEMANA, TURNO, GRUPO, MINA, LABOR/POSTURA, GRADO, SUMINISTRO, m³, CNC, etc.</div>
</header>

<div class="container">

  <div class="card toolbar">
    <div class="field" style="min-width:160px">
      <label>Mes</label>
      <select id="f_mes" onchange="renderAll()">
        <option value="TODOS">Todos</option>
      </select>
    </div>
    <div class="field" style="min-width:160px">
      <label>Turno</label>
      <select id="f_turno" onchange="renderAll()">
        <option value="TODOS">Todos</option>
      </select>
    </div>
    <div class="field" style="min-width:190px">
      <label>Mina</label>
      <select id="f_mina" onchange="renderAll()">
        <option value="TODOS">Todas</option>
      </select>
    </div>
    <div class="field" style="min-width:190px">
      <label>Grado</label>
      <select id="f_grado" onchange="renderAll()">
        <option value="TODOS">Todos</option>
      </select>
    </div>
    <div class="field" style="min-width:220px">
      <label>Suministro</label>
      <select id="f_suministro" onchange="renderAll()">
        <option value="TODOS">Todos</option>
      </select>
    </div>

    <button class="btn ok right" onclick="openModal()">+ Nuevo registro</button>
    <button class="btn gray" onclick="exportCSV()">Exportar CSV</button>
    <button class="btn primary" onclick="resetAll()">Limpiar filtros</button>
  </div>

  <div class="card kpis" id="kpis"></div>

  <div class="card">
    <div class="titlebar">
      <div>
        <h2>Registros</h2>
        <div class="pill" id="pill"></div>
      </div>
      <div class="pill">Tip: Mes/Semana se calculan desde FECHA al guardar.</div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>FECHA</th><th>MES</th><th>SEMANA</th><th>TURNO</th><th>GRUPO</th><th>MINA</th><th>LABOR/POSTURA</th><th>GRADO</th><th>SUMINISTRO</th>
            <th>PLANIFICADO (m³)</th><th>SUMINISTRADO (m³)</th><th>PENDIENTE (m³)</th><th>RECHAZADO (m³)</th><th>REAGENDADO (m³)</th><th>ELIMINADO (m³)</th>
            <th>N° GUÍA</th><th>H. SALIDA PLANTA</th><th>H. LLEGADA OBRA</th><th>H. INICIO DESCARGA</th><th>H. TÉRMINO DESCARGA</th>
            <th>CNC NIVEL 2</th><th>CNC NIVEL 1</th><th>RESPONSABLE CNC</th><th>SALA DE CONTROL</th><th>OBSERVACIÓN</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="backdrop" id="backdrop" onclick="if(event.target.id==='backdrop') closeModal()">
  <div class="card modal">
    <div class="titlebar">
      <h2>Ingreso de nuevos registros de hormigón</h2>
      <button class="btn primary" onclick="closeModal()">Cerrar</button>
    </div>
    <div class="body">
      <div class="grid">
        <div>
          <label>FECHA</label>
          <input id="i_fecha" type="date" onchange="autoMesSemana()"/>
          <div class="hint">Se guardará MES y SEMANA automáticamente.</div>
        </div>
        <div>
          <label>MES</label>
          <input id="i_mes" type="text" placeholder="(auto)" disabled />
        </div>
        <div>
          <label>SEMANA</label>
          <input id="i_semana" type="text" placeholder="(auto)" disabled />
        </div>

        <div>
          <label>TURNO</label>
          <select id="i_turno"></select>
        </div>
        <div>
          <label>GRUPO</label>
          <select id="i_grupo"></select>
        </div>

        <div>
          <label>MINA</label>
          <select id="i_mina" onchange="syncLaborOptions()"></select>
        </div>

        <div style="grid-column: span 2;">
          <label>LABOR/POSTURA</label>
          <select id="i_labor"></select>
        </div>

        <div>
          <label>GRADO</label>
          <select id="i_grado"></select>
        </div>

        <div>
          <label>SUMINISTRO</label>
          <select id="i_suministro"></select>
        </div>

        <div>
          <label>PLANIFICADO (m³)</label>
          <input id="i_plan" type="number" step="0.01" placeholder="0"/>
        </div>
        <div>
          <label>SUMINISTRADO (m³)</label>
          <input id="i_sum" type="number" step="0.01" placeholder="0"/>
        </div>
        <div>
          <label>PENDIENTE (m³)</label>
          <input id="i_pen" type="number" step="0.01" placeholder="0"/>
        </div>
        <div>
          <label>RECHAZADO (m³)</label>
          <input id="i_rec" type="number" step="0.01" placeholder="0"/>
        </div>
        <div>
          <label>REAGENDADO (m³)</label>
          <input id="i_rea" type="number" step="0.01" placeholder="0"/>
        </div>
        <div>
          <label>ELIMINADO (m³)</label>
          <input id="i_eli" type="number" step="0.01" placeholder="0"/>
        </div>

        <div style="grid-column: span 2;">
          <label>N° GUÍA</label>
          <input id="i_guia" type="text" placeholder=""/>
        </div>

        <div>
          <label>HORA SALIDA PLANTA</label>
          <input id="i_hsal" type="time"/>
        </div>
        <div>
          <label>HORA LLEGADA OBRA</label>
          <input id="i_hlle" type="time"/>
        </div>
        <div>
          <label>HORA INICIO DESCARGA</label>
          <input id="i_hini" type="time"/>
        </div>
        <div>
          <label>HORA TERMINO DESCARGA</label>
          <input id="i_hter" type="time"/>
        </div>

        <div>
          <label>CNC NIVEL 2</label>
          <select id="i_cnc2"></select>
        </div>
        <div>
          <label>CNC NIVEL 1</label>
          <select id="i_cnc1"></select>
        </div>
        <div>
          <label>RESPONSABLE CNC</label>
          <select id="i_resp"></select>
        </div>

        <div style="grid-column: span 2;">
          <label>SALA DE CONTROL</label>
          <select id="i_sala"></select>
        </div>

        <div style="grid-column: span 6;">
          <label>OBSERVACIÓN</label>
          <textarea id="i_obs" placeholder=""></textarea>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:14px;">
        <button class="btn ok" onclick="saveRecord()">Guardar registro</button>
        <button class="btn gray" onclick="loadDemo()">Cargar demo</button>
        <div class="hint" style="margin-left:auto;">Los datos se guardan en tu navegador (localStorage).</div>
      </div>
    </div>
  </div>
</div>

<script>
const DROPDOWNS = {"GRADO": ["GN-25", "GN-65", "HB-30", "HB-40", "HB-50", "HB-70", "HN-30", "HN-40", "HN-50", "HN-70", "SH-22,5 FIBRA", "SH-22,5 NORMAL", "SH-300"], "SUMINISTRO": ["En Obra", "En Planta"], "TURNO": ["1", "2", "A", "B", "C"], "GRUPO": ["Grupo_1", "Grupo_2", "Grupo_3", "Grupo_4"], "SALA_CONTROL": ["Alvaro Coloma Toledo", "Carlos Salazar Rodriguez", "Marcelo Henriquez Ortiz", "Martin Arriaza Vidal"], "CNC_NIVEL_2": ["APP no disponible", "Agua", "Bomba F/S", "Cambio de Postura", "Cambio de prioridad", "Cancelacion Suministro", "Cancha no lista", "Capacidad maxima equipo", "Cenefa", "Comunicación", "Confirmacion fuera de horario", "Energía", "Equipo F/S Xtreme", "Equipo shortcrete F/S", "Equipos en área", "Espera equipo en planta", "Falla planta", "Falta operador", "Falta personal OOCC", "Falta suministros", "Incumplimiento horario APP", "Indisponibilidad de mixer propio", "Interferencia por derrumbe", "Lento retorno de equipos", "Liberación de gases", "Marina en postura", "Mezcladores", "Mixer Retrasado", "Movilizaciones", "Pedido Fuera de Programa", "Planificación errónea", "Planta sin comunicación", "Postura rematada con menos m3", "Problemas con escolta", "Problemas en la calidad", "Proceso de carguío tarda mas de lo programado", "Restricción por evento climatico", "Ruta marina", "Simulacros", "Sin Autorizacion DET", "Sin retorno de mixer a planta", "Sismología", "Somnolencia", "Suspension Administrativa", "Tarjeta Verde", "Trabajo otras empresas", "Trabajos en ruta", "Trabajos otras disciplinas", "Traslado personal DET", "Ventana horaria", "Visita Gerencia GSYS", "ruta no apta para el ingreso de mixer"], "CNC_NIVEL_1": ["APP no disponible", "Calidad", "Clima", "Comunicación", "Dotación no disponible", "Equipo F/S", "Equipos", "Espera equipo en planta", "Falla operacional", "Frente no preparada", "Incumplimiento horario APP", "Indisponibilidad de mixer propio", "Indisponibilidad de planta", "Interferencia empresas", "Liberación de gases", "Pedido", "Personal", "Planificación errónea", "Planta", "Postura", "Prioridades", "Ruta", "Ruta Codelco", "Servicios", "Sismología", "Suministro"], "RESPONSABLE_CNC": ["CODELCO", "INTERNA", "SUMINISTRO"], "MINA_HEADERS": ["ESMERALDA", "ESMERALDA_PANEL_1", "DIABLO_REGIMIENTO", "PILAR_NORTE", "TENIENTE_7", "TENIENTE_8", "COLÓN", "ADIT_71"], "MINA_TO_LABOR": {"ESMERALDA": ["C-25 Z-44 HW", "C-25 Z-45 HW", "C-49 IZ", "C-49 OP-48", "C-55 IZ"], "ESMERALDA_PANEL_1": ["C-23 Z-0"], "DIABLO_REGIMIENTO": ["C-23 Z-42 FW", "C-23 Z-42 HW"], "PILAR_NORTE": ["C-0 SOC. SUR A Z-10", "C-2 Z-10/9", "C-2 Z-5/6"], "TENIENTE_7": ["Acceso Sur Loop (Pto 4)", "CAV acceso descarga CH DT (Pto 13)", "CX 1S/2S con Loop 1S (Pto 8)", "Fr Inv descarga Dacita (Pto 12)", "Galería curva CH DT (Pto 14)", "Loop Fw A (Pto 6)", "Loop Fw B (Pto 7)", "Loop Hw / Adit 65 (Pto 10)", "Loop Hw / CX Loop 1S/2S (Pto 9)", "Loop Hw entre P4 y P5 (Pto 11)", "OP-26 Pto 22-A", "OP-26 Pto 22-B", "OP-26 Pto 23", "OP-26 Pto 24", "OP-27 Pto 20-A", "OP-27 Pto 20-B", "OP-27 Pto 21-A", "OP-27 Pto 21-B", "OP-27 Pto 22-A", "OP-27 UH", "Pilar Bz 24-1S (Pto 1)", "Soc. Hw 1 (Pto 2)", "Soc. Hw 1 / Acceso Sur Loop (Pto 3)", "Soc. Hw 1 / Loop Norte (Pto 5)"], "TENIENTE_8": ["OP 24"], "COLÓN": ["EDIFICIO 132"], "ADIT_71": ["EST. 1 A EST. 2", "EST. 1 A SUPERFICIE", "EST. 5 A EST. 4"]}};

const KEY = "HORMIGON_REGISTROS_V1";
let DATA = [];

function loadData(){
  try{ DATA = JSON.parse(localStorage.getItem(KEY) || "[]"); }catch(e){ DATA=[]; }
}
function saveData(){ localStorage.setItem(KEY, JSON.stringify(DATA)); }

function monthName(d){
  const m=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  return m[d.getMonth()];
}
function isoWeek(d){
  const date=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum=date.getUTCDay()||7;
  date.setUTCDate(date.getUTCDate()+4-dayNum);
  const yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const week=Math.ceil((((date-yearStart)/86400000)+1)/7);
  return week;
}

function populateSelect(sel, items, placeholder=null){
  sel.innerHTML="";
  if(placeholder!==null) {
    const o=document.createElement("option"); o.value=""; o.textContent=placeholder; sel.appendChild(o);
  }
  (items||[]).forEach(v=>{
    const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o);
  });
}

function initFilters(){
  const mesSet=new Set(DATA.map(r=>r.MES).filter(Boolean));
  const turnoSet=new Set(DATA.map(r=>r.TURNO).filter(Boolean));
  const minaSet=new Set(DATA.map(r=>r.MINA).filter(Boolean));
  const gradoSet=new Set(DATA.map(r=>r.GRADO).filter(Boolean));
  const sumSet=new Set(DATA.map(r=>r.SUMINISTRO).filter(Boolean));

  const f_mes=document.getElementById("f_mes");
  const f_turno=document.getElementById("f_turno");
  const f_mina=document.getElementById("f_mina");
  const f_grado=document.getElementById("f_grado");
  const f_sum=document.getElementById("f_suministro");

  const append = (sel, arr) => {
    const first=sel.querySelector("option")?.outerHTML || "";
    sel.innerHTML=first;
    arr.sort((a,b)=>String(a).localeCompare(String(b), "es"));
    arr.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o); });
  };

  append(f_mes, Array.from(mesSet));
  append(f_turno, Array.from(turnoSet).length?Array.from(turnoSet):DROPDOWNS.TURNO);
  append(f_mina, Array.from(minaSet).length?Array.from(minaSet):DROPDOWNS.MINA_HEADERS);
  append(f_grado, Array.from(gradoSet).length?Array.from(gradoSet):DROPDOWNS.GRADO);
  append(f_sum, Array.from(sumSet).length?Array.from(sumSet):DROPDOWNS.SUMINISTRO);
}

function getFiltered(){
  const mes=document.getElementById("f_mes").value;
  const turno=document.getElementById("f_turno").value;
  const mina=document.getElementById("f_mina").value;
  const grado=document.getElementById("f_grado").value;
  const sum=document.getElementById("f_suministro").value;

  return DATA.filter(r=>{
    if(mes!=="TODOS" && r.MES!==mes) return false;
    if(turno!=="TODOS" && r.TURNO!==turno) return false;
    if(mina!=="TODOS" && r.MINA!==mina) return false;
    if(grado!=="TODOS" && r.GRADO!==grado) return false;
    if(sum!=="TODOS" && r.SUMINISTRO!==sum) return false;
    return true;
  });
}

function renderKPIs(rows){
  const n=rows.length;
  const sum=(k)=>rows.reduce((a,r)=>a+(Number(r[k])||0),0);
  const plan=sum("PLANIFICADO");
  const sumi=sum("SUMINISTRADO");
  const pend=sum("PENDIENTE");
  const rech=sum("RECHAZADO");
  const rea=sum("REAGENDADO");
  const eli=sum("ELIMINADO");
  const pct = plan>0 ? (sumi/plan*100) : 0;

  const kpis=document.getElementById("kpis");
  kpis.innerHTML = `
    <div class="kpi"><div class="v">${n}</div><div class="t">Registros (filtro)</div></div>
    <div class="kpi"><div class="v">${plan.toFixed(1)}</div><div class="t">Planificado total (m³)</div></div>
    <div class="kpi"><div class="v">${sumi.toFixed(1)}</div><div class="t">Suministrado total (m³)</div></div>
    <div class="kpi"><div class="v">${pct.toFixed(1)}%</div><div class="t">Cumplimiento (Sumin./Planif.)</div></div>
    <div class="kpi"><div class="v">${pend.toFixed(1)}</div><div class="t">Pendiente (m³)</div></div>
    <div class="kpi"><div class="v">${(rech+rea+eli).toFixed(1)}</div><div class="t">No ejecutado (Rech+Reag+Elim) (m³)</div></div>
  `;
}

function renderTable(rows){
  const tb=document.getElementById("tbody");
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td>${esc(r.FECHA)}</td><td>${esc(r.MES)}</td><td>${esc(r.SEMANA)}</td><td>${esc(r.TURNO)}</td><td>${esc(r.GRUPO)}</td>
      <td>${esc(r.MINA)}</td><td>${esc(r["LABOR/POSTURA"])}</td><td>${esc(r.GRADO)}</td><td>${esc(r.SUMINISTRO)}</td>
      <td>${fmtNum(r.PLANIFICADO)}</td><td>${fmtNum(r.SUMINISTRADO)}</td><td>${fmtNum(r.PENDIENTE)}</td><td>${fmtNum(r.RECHAZADO)}</td><td>${fmtNum(r.REAGENDADO)}</td><td>${fmtNum(r.ELIMINADO)}</td>
      <td>${esc(r["NÚMERO GUÍA"])}</td><td>${esc(r["HORA SALIDA PLANTA"])}</td><td>${esc(r["HORA LLEGADA OBRA"])}</td><td>${esc(r["HORA INICIO DESCARGA"])}</td><td>${esc(r["HORA TERMINO DESCARGA"])}</td>
      <td>${esc(r["CNC NIVEL 2"])}</td><td>${esc(r["CNC NIVEL 1"])}</td><td>${esc(r["RESPONSABLE CNC"])}</td><td>${esc(r["SALA DE CONTROL"])}</td><td>${esc(r.OBSERVACIÓN)}</td>
    </tr>
  `).join("");

  document.getElementById("pill").textContent = `${rows.length} fila(s)`;
}

function esc(v){ return (v==null?"":String(v)).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function fmtNum(v){ const n=Number(v); return isFinite(n) ? n.toFixed(1) : ""; }

function renderAll(){
  const rows=getFiltered();
  renderKPIs(rows);
  renderTable(rows);
}

function resetAll(){
  document.getElementById("f_mes").value="TODOS";
  document.getElementById("f_turno").value="TODOS";
  document.getElementById("f_mina").value="TODOS";
  document.getElementById("f_grado").value="TODOS";
  document.getElementById("f_suministro").value="TODOS";
  renderAll();
}

function openModal(){
  document.getElementById("backdrop").style.display="flex";
  document.getElementById("i_fecha").valueAsDate = new Date();
  autoMesSemana();
}
function closeModal(){ document.getElementById("backdrop").style.display="none"; }

function autoMesSemana(){
  const v=document.getElementById("i_fecha").value;
  if(!v) return;
  const d=new Date(v+"T00:00:00");
  document.getElementById("i_mes").value=monthName(d);
  document.getElementById("i_semana").value=String(isoWeek(d));
}

function syncLaborOptions(){
  const mina=document.getElementById("i_mina").value;
  const opts = DROPDOWNS.MINA_TO_LABOR[mina] || [];
  populateSelect(document.getElementById("i_labor"), opts, "Seleccionar...");
}

function initModalDropdowns(){
  populateSelect(document.getElementById("i_turno"), DROPDOWNS.TURNO, "Seleccionar...");
  populateSelect(document.getElementById("i_grupo"), DROPDOWNS.GRUPO, "Seleccionar...");
  populateSelect(document.getElementById("i_mina"), DROPDOWNS.MINA_HEADERS, "Seleccionar...");
  populateSelect(document.getElementById("i_grado"), DROPDOWNS.GRADO, "Seleccionar...");
  populateSelect(document.getElementById("i_suministro"), DROPDOWNS.SUMINISTRO, "Seleccionar...");
  populateSelect(document.getElementById("i_cnc2"), DROPDOWNS.CNC_NIVEL_2, "Seleccionar...");
  populateSelect(document.getElementById("i_cnc1"), DROPDOWNS.CNC_NIVEL_1, "Seleccionar...");
  populateSelect(document.getElementById("i_resp"), DROPDOWNS.RESPONSABLE_CNC, "Seleccionar...");
  populateSelect(document.getElementById("i_sala"), DROPDOWNS.SALA_CONTROL, "Seleccionar...");
  syncLaborOptions();
}

function saveRecord(){
  const fecha=document.getElementById("i_fecha").value;
  if(!fecha) return alert("Ingresa FECHA.");
  const d=new Date(fecha+"T00:00:00");
  const rec={
    "FECHA": fecha.split("-").reverse().join("/"),
    "MES": monthName(d),
    "SEMANA": String(isoWeek(d)),
    "TURNO": document.getElementById("i_turno").value,
    "GRUPO": document.getElementById("i_grupo").value,
    "MINA": document.getElementById("i_mina").value,
    "LABOR/POSTURA": document.getElementById("i_labor").value,
    "GRADO": document.getElementById("i_grado").value,
    "SUMINISTRO": document.getElementById("i_suministro").value,
    "PLANIFICADO": num(document.getElementById("i_plan").value),
    "SUMINISTRADO": num(document.getElementById("i_sum").value),
    "PENDIENTE": num(document.getElementById("i_pen").value),
    "RECHAZADO": num(document.getElementById("i_rec").value),
    "REAGENDADO": num(document.getElementById("i_rea").value),
    "ELIMINADO": num(document.getElementById("i_eli").value),
    "NÚMERO GUÍA": document.getElementById("i_guia").value,
    "HORA SALIDA PLANTA": document.getElementById("i_hsal").value,
    "HORA LLEGADA OBRA": document.getElementById("i_hlle").value,
    "HORA INICIO DESCARGA": document.getElementById("i_hini").value,
    "HORA TERMINO DESCARGA": document.getElementById("i_hter").value,
    "CNC NIVEL 2": document.getElementById("i_cnc2").value,
    "CNC NIVEL 1": document.getElementById("i_cnc1").value,
    "RESPONSABLE CNC": document.getElementById("i_resp").value,
    "SALA DE CONTROL": document.getElementById("i_sala").value,
    "OBSERVACIÓN": document.getElementById("i_obs").value
  };
  DATA.unshift(rec);
  saveData();
  initFilters();
  closeModal();
  renderAll();
}

function num(v){ const n=Number(v); return isFinite(n)?n:0; }

function exportCSV(){
  const rows=getFiltered();
  if(!rows.length) return alert("No hay filas para exportar.");
  const cols=["FECHA","MES","SEMANA","TURNO","GRUPO","MINA","LABOR/POSTURA","GRADO","SUMINISTRO","PLANIFICADO","SUMINISTRADO","PENDIENTE","RECHAZADO","REAGENDADO","ELIMINADO","NÚMERO GUÍA","HORA SALIDA PLANTA","HORA LLEGADA OBRA","HORA INICIO DESCARGA","HORA TERMINO DESCARGA","CNC NIVEL 2","CNC NIVEL 1","RESPONSABLE CNC","SALA DE CONTROL","OBSERVACIÓN"];
  const escCSV=(s)=>('"'+String(s??"").replaceAll('"','""')+'"');
  let csv = cols.map(escCSV).join(",")+"
";
  for(const r of rows){
    csv += cols.map(c=>escCSV(r[c])).join(",")+"
";
  }
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="reporte_hormigon.csv";
  document.body.appendChild(a); a.click(); a.remove();
}

function loadDemo(){
  const demo = [{"FECHA": "28/10/2025", "MES": "Octubre", "SEMANA": "44", "TURNO": "1", "GRUPO": "Grupo_1", "MINA": "ESMERALDA", "LABOR/POSTURA": "C-49 IZ", "GRADO": "SH-22,5 NORMAL", "SUMINISTRO": "En Planta", "PLANIFICADO": 10, "SUMINISTRADO": 9, "PENDIENTE": 1, "RECHAZADO": 0, "REAGENDADO": 0, "ELIMINADO": 0, "NÚMERO GUÍA": "123", "HORA SALIDA PLANTA": "08:00", "HORA LLEGADA OBRA": "08:45", "HORA INICIO DESCARGA": "08:55", "HORA TERMINO DESCARGA": "09:15", "CNC NIVEL 2": "Interferencia por derrumbe", "CNC NIVEL 1": "Ruta Codelco", "RESPONSABLE CNC": "CODELCO", "SALA DE CONTROL": "Carlos Salazar Rodriguez", "OBSERVACIÓN": "Demo"}, {"FECHA": "07/11/2025", "MES": "Noviembre", "SEMANA": "45", "TURNO": "2", "GRUPO": "Grupo_2", "MINA": "TENIENTE_7", "LABOR/POSTURA": "OP-26 Pto 22-A", "GRADO": "SH-22,5 FIBRA", "SUMINISTRO": "En Obra", "PLANIFICADO": 12, "SUMINISTRADO": 12, "PENDIENTE": 0, "RECHAZADO": 0, "REAGENDADO": 0, "ELIMINADO": 0, "NÚMERO GUÍA": "124", "HORA SALIDA PLANTA": "12:00", "HORA LLEGADA OBRA": "12:50", "HORA INICIO DESCARGA": "13:00", "HORA TERMINO DESCARGA": "13:20", "CNC NIVEL 2": "Comunicación", "CNC NIVEL 1": "Ruta Codelco", "RESPONSABLE CNC": "CODELCO", "SALA DE CONTROL": "Martin Arriaza Vidal", "OBSERVACIÓN": "Demo"}];
  DATA = demo.concat(DATA);
  saveData();
  initFilters();
  renderAll();
  closeModal();
}

(function init(){
  loadData();
  initModalDropdowns();
  initFilters();
  renderAll();
})();
</script>
</body>
</html>
