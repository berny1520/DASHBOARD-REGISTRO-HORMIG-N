<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard HormigÃ³n â€“ Sala de Control</title>

<style>
:root{
  --primary:#d9232d;
  --dark:#222;
  --bg:#f2f4f7;
  --card:#ffffff;
  --muted:#777;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg);
}
header{
  background:var(--dark);
  color:#fff;
  padding:12px 28px;
}
header .wrap{
  max-width:1400px;
  margin:auto;
  display:flex;
  align-items:center;
  gap:16px;
}
header img{height:52px}
.container{
  max-width:1400px;
  margin:20px auto;
  padding:0 14px;
}
.card{
  background:var(--card);
  border-radius:12px;
  padding:16px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  margin-bottom:18px;
}
.card h2{
  margin:0 0 10px;
  font-size:18px;
}
.form-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:12px 18px;
}
label{
  font-size:11px;
  font-weight:bold;
  color:var(--muted);
  display:block;
  margin-bottom:4px;
}
select,input,textarea{
  width:100%;
  padding:6px 8px;
  border-radius:6px;
  border:1px solid #cfd3d8;
  font-size:13px;
}
textarea{resize:vertical;min-height:40px;}
.summary{
  font-size:13px;
  margin-top:10px;
}
.summary span{
  color:var(--primary);
  font-weight:bold;
}
.btn-bar{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
}
button{
  border:none;
  border-radius:6px;
  padding:7px 12px;
  font-size:13px;
  cursor:pointer;
}
.btn-primary{background:var(--primary);color:#fff;}
.btn-secondary{background:#555;color:#fff;}
.btn-ghost{background:#eee;color:#333;}
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
th,td{
  padding:4px 6px;
  border-bottom:1px solid #e1e1e1;
  white-space:nowrap;
}
th{background:#f0f0f0;text-align:left;}
tr:nth-child(even) td{background:#fafafa;}
.footer{
  text-align:center;
  font-size:12px;
  color:#999;
  margin:16px 0 30px;
}
</style>
</head>

<body>

<header>
  <div class="wrap">
    <img src="logo_Xtreme.png" alt="Xtreme">
    <div>
      <h1>Dashboard HormigÃ³n â€“ Sala de Control</h1>
      <div style="font-size:13px;color:#ccc">
        Google Sheets Â· Apps Script Â· AuditorÃ­a por usuario
      </div>
    </div>
  </div>
</header>

<div class="container">

  <!-- DATOS HORMIGÃ“N -->
  <div class="card">
    <h2>Datos de HormigÃ³n</h2>
    <div class="form-grid">
      <div>
        <label>Grado HormigÃ³n</label>
        <select id="grado"></select>
      </div>
      <div>
        <label>Suministro</label>
        <select id="suministro"></select>
      </div>
      <div>
        <label>Turno</label>
        <select id="turno"></select>
      </div>
      <div>
        <label>Grupo</label>
        <select id="grupo"></select>
      </div>
      <div>
        <label>Mina (libre)</label>
        <input id="mina" placeholder="Ej: Teniente">
      </div>
      <div>
        <label>Postura (libre)</label>
        <input id="postura" placeholder="Ej: C-49 IZ">
      </div>
    </div>
  </div>

  <!-- CONDICIÃ“N CNC -->
  <div class="card">
    <h2>CondiciÃ³n CNC</h2>
    <div class="form-grid">
      <div>
        <label>Responsable CNC</label>
        <select id="resp"></select>
      </div>
      <div>
        <label>CNC Nivel 1</label>
        <select id="cnc1"></select>
      </div>
      <div>
        <label>CNC Nivel 2</label>
        <select id="cnc2"></select>
      </div>
      <div>
        <label>ObservaciÃ³n / Detalle</label>
        <textarea id="obs" placeholder="Observaciones adicionales"></textarea>
      </div>
    </div>
    <div class="summary" id="resumen"></div>
  </div>

  <!-- USUARIO + GUARDADO -->
  <div class="card">
    <h2>Usuario y guardado</h2>
    <div class="form-grid">
      <div>
        <label>Usuario (nombre o correo)</label>
        <input id="usuario" placeholder="Ej: ladasme@xtreme.cl">
      </div>
    </div>

    <div class="btn-bar">
      <button class="btn-primary" type="button" onclick="guardarRegistro()">ðŸ’¾ Guardar en Google Sheets</button>
      <button class="btn-secondary" type="button" onclick="limpiarFormulario()">ðŸ§¹ Limpiar formulario</button>
      <button class="btn-ghost" type="button" onclick="cargarHistorial()">ðŸ“œ Actualizar historial</button>
    </div>
    <div id="estado" style="font-size:12px;color:#555;margin-top:8px;"></div>
  </div>

  <!-- HISTORIAL / AUDITORÃA -->
  <div class="card">
    <h2>Historial reciente (auditorÃ­a)</h2>
    <div id="historial">Sin datos cargados aÃºn.</div>
  </div>

  <div class="footer">
    Xtreme Mining Â· Hormigones Â· IntegraciÃ³n con Google Sheets (DATOS & REGISTRO)
  </div>

</div>

<script>
/* =====================================================
   CONFIGURACIÃ“N â€“ SOLO CAMBIA ESTO
===================================================== */

// URL de tu Web App de Apps Script (la que termina en /exec)
const SCRIPT_URL = "PEGAR_AQUI_LA_URL_DE_TU_WEB_APP"; // <-- REEMPLAZA ESTO

/* =====================================================
   UTILIDADES
===================================================== */
function setEstado(msg, ok=true){
  const el = document.getElementById("estado");
  el.textContent = msg;
  el.style.color = ok ? "#0a7a20" : "#b00020";
}

function fillSelect(sel, values){
  sel.innerHTML = '<option value="">Seleccionar...</option>';
  [...new Set(values.filter(v => v !== "" && v != null))].forEach(v=>{
    const o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    sel.appendChild(o);
  });
}

/* =====================================================
   CARGA LISTAS DESDE HOJA DATOS (Apps Script)
   Hoja DATOS debe tener columnas:
   GRADO | SUMINISTRO | TURNO | GRUPO | RESPONSABLE_CNC | CNC_NIVEL_1 | CNC_NIVEL_2
===================================================== */
let datosDatos = [];

function cargarListasDesdeGoogle(){
  if (!SCRIPT_URL || SCRIPT_URL.includes("PEGAR_AQUI")) {
    console.warn("Falta configurar SCRIPT_URL con la web app de Apps Script.");
    setEstado("Falta configurar conexiÃ³n con Google Sheets (SCRIPT_URL).", false);
    return;
  }

  fetch(SCRIPT_URL + "?action=datos")
    .then(r => {
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    })
    .then(json => {
      datosDatos = json.datos || [];

      fillSelect(document.getElementById("grado"),       datosDatos.map(d=>d.GRADO));
      fillSelect(document.getElementById("suministro"),  datosDatos.map(d=>d.SUMINISTRO));
      fillSelect(document.getElementById("turno"),       datosDatos.map(d=>d.TURNO));
      fillSelect(document.getElementById("grupo"),       datosDatos.map(d=>d.GRUPO));
      fillSelect(document.getElementById("resp"),        datosDatos.map(d=>d.RESPONSABLE_CNC));

      setEstado("Listas cargadas desde Google Sheets (DATOS).", true);
      actualizarResumen();
    })
    .catch(err => {
      console.error(err);
      setEstado("No se pudo leer la hoja DATOS desde Google Sheets.", false);
    });
}

/* =====================================================
   CNC ANIDADO
===================================================== */
const selResp = document.getElementById("resp");
const selCnc1 = document.getElementById("cnc1");
const selCnc2 = document.getElementById("cnc2");

selResp.addEventListener("change", ()=>{
  const filtrado = datosDatos.filter(d => d.RESPONSABLE_CNC === selResp.value);
  fillSelect(selCnc1, filtrado.map(d=>d.CNC_NIVEL_1));
  selCnc2.innerHTML = '<option value="">Seleccionar...</option>';
  actualizarResumen();
});

selCnc1.addEventListener("change", ()=>{
  const filtrado = datosDatos.filter(d =>
    d.RESPONSABLE_CNC === selResp.value &&
    d.CNC_NIVEL_1 === selCnc1.value
  );
  fillSelect(selCnc2, filtrado.map(d=>d.CNC_NIVEL_2));
  actualizarResumen();
});

selCnc2.addEventListener("change", actualizarResumen);

/* =====================================================
   RESUMEN EN TIEMPO REAL
===================================================== */
function actualizarResumen(){
  const g  = grado.value;
  const t  = turno.value;
  const gr = grupo.value;
  const mi = mina.value;
  const po = postura.value;
  const r  = resp.value;
  const c1 = cnc1.value;
  const c2 = cnc2.value;

  document.getElementById("resumen").innerHTML =
    `Grado <span>${g || "-"}</span> Â· Turno <span>${t || "-"}</span> Â· Grupo <span>${gr || "-"}</span> Â· `+
    `Mina <span>${mi || "-"}</span> Â· Postura <span>${po || "-"}</span><br>` +
    `CNC <span>${r || "-"}</span> / <span>${c1 || "-"}</span> / <span>${c2 || "-"}</span>`;
}

document.querySelectorAll("select,input,textarea")
  .forEach(el => el.addEventListener("change", actualizarResumen));

/* =====================================================
   GUARDAR EN HOJA REGISTRO (POST)
===================================================== */
function guardarRegistro(){
  if (!SCRIPT_URL || SCRIPT_URL.includes("PEGAR_AQUI")) {
    alert("Falta configurar SCRIPT_URL con la URL de la Web App de Apps Script.");
    return;
  }

  const payload = {
    fechaIso:   new Date().toISOString(),
    usuario:    document.getElementById("usuario").value || "SIN_USUARIO",
    grado:      grado.value,
    suministro: suministro.value,
    turno:      turno.value,
    grupo:      grupo.value,
    mina:       mina.value,
    postura:    postura.value,
    resp:       resp.value,
    cnc1:       cnc1.value,
    cnc2:       cnc2.value,
    observacion:document.getElementById("obs").value || "",
    userAgent:  navigator.userAgent
  };

  if (!payload.grado || !payload.suministro || !payload.turno || !payload.grupo) {
    alert("Completa al menos Grado, Suministro, Turno y Grupo antes de guardar.");
    return;
  }

  setEstado("Enviando registro a Google Sheets (REGISTRO)â€¦", true);

  fetch(SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  })
  .then(r => {
    if (!r.ok) throw new Error("HTTP " + r.status);
    return r.json().catch(()=>({status:"OK"}));
  })
  .then(() => {
    setEstado("Registro guardado correctamente en la hoja REGISTRO.", true);
  })
  .catch(err => {
    console.error(err);
    setEstado("Error guardando en Google Sheets. Revisa la Web App.", false);
  });
}

/* =====================================================
   LIMPIAR FORMULARIO
===================================================== */
function limpiarFormulario(){
  grado.value = "";
  suministro.value = "";
  turno.value = "";
  grupo.value = "";
  mina.value = "";
  postura.value = "";
  resp.value = "";
  selCnc1.innerHTML = '<option value="">Seleccionar...</option>';
  selCnc2.innerHTML = '<option value="">Seleccionar...</option>';
  document.getElementById("obs").value = "";
  actualizarResumen();
  setEstado("Formulario limpio.", true);
}

/* =====================================================
   CARGAR HISTORIAL (GET action=historial)
===================================================== */
function cargarHistorial(){
  const cont = document.getElementById("historial");

  if (!SCRIPT_URL || SCRIPT_URL.includes("PEGAR_AQUI")) {
    cont.textContent = "Falta configurar SCRIPT_URL para leer el historial.";
    return;
  }

  cont.textContent = "Cargando historial desde Google Sheetsâ€¦";

  fetch(SCRIPT_URL + "?action=historial")
    .then(r => {
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    })
    .then(json => {
      const data = json.registros || [];
      if (!data.length){
        cont.textContent = "Sin registros en el historial aÃºn.";
        return;
      }

      let html = "<table><tr>" +
        "<th>Fecha</th><th>Usuario</th><th>Grado</th><th>Suministro</th>" +
        "<th>Turno</th><th>Grupo</th><th>Mina</th><th>Postura</th>" +
        "<th>Responsable</th><th>CNC1</th><th>CNC2</th><th>Obs.</th>" +
        "</tr>";

      data.forEach(r=>{
        const fecha = r.FechaISO || r.fechaIso || "";
        html += `<tr>
          <td>${fecha}</td>
          <td>${r.Usuario || r.usuario || ""}</td>
          <td>${r.Grado || r.grado || ""}</td>
          <td>${r.Suministro || r.suministro || ""}</td>
          <td>${r.Turno || r.turno || ""}</td>
          <td>${r.Grupo || r.grupo || ""}</td>
          <td>${r.Mina || r.mina || ""}</td>
          <td>${r.Postura || r.postura || ""}</td>
          <td>${r.ResponsableCNC || r.resp || ""}</td>
          <td>${r.CNCNivel1 || r.cnc1 || ""}</td>
          <td>${r.CNCNivel2 || r.cnc2 || ""}</td>
          <td>${r.Observacion || r.observacion || ""}</td>
        </tr>`;
      });
      html += "</table>";
      cont.innerHTML = html;
    })
    .catch(err => {
      console.error(err);
      cont.textContent = "Error leyendo historial desde Google Sheets.";
    });
}

/* =====================================================
   INICIALIZACIÃ“N
===================================================== */
document.addEventListener("DOMContentLoaded", ()=>{
  cargarListasDesdeGoogle();
  actualizarResumen();
  // Si quieres que cargue el historial al abrir:
  // cargarHistorial();
});
</script>

</body>
</html>
